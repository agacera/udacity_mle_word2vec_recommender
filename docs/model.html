---

title: Word2Vec Model
keywords: fastai
sidebar: home_sidebar

summary: "This module exposes classes and functions related to training of the Word2Vec recommender using the Gensim library."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: notebooks/01_model.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="GensimParameters" class="doc_header"><code>class</code> <code>GensimParameters</code><a href="https://github.com/agacera/udacity_mle_word2vec_recommender/tree/master/word2vec_recommender/model.py#L26" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>GensimParameters</code>(<strong><code>window</code></strong>:<code>int</code>=<em><code>10</code></em>, <strong><code>iter</code></strong>:<code>int</code>=<em><code>20</code></em>, <strong><code>sg</code></strong>:<code>int</code>=<em><code>1</code></em>, <strong><code>hs</code></strong>:<code>int</code>=<em><code>0</code></em>, <strong><code>negative</code></strong>:<code>int</code>=<em><code>10</code></em>, <strong><code>alpha</code></strong>:<code>float</code>=<em><code>0.03</code></em>, <strong><code>min_alpha</code></strong>:<code>float</code>=<em><code>0.0007</code></em>, <strong><code>seed</code></strong>:<code>int</code>=<em><code>14</code></em>, <strong><code>compute_loss</code></strong>:<code>bool</code>=<em><code>True</code></em>) :: <code>tuple</code></p>
</blockquote>
<p>GensimParameters(window, iter, sg, hs, negative, alpha, min_alpha, seed, compute_loss)</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">gensim_parameters</span> <span class="o">=</span> <span class="n">GensimParameters</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="generate_sentences_by_user" class="doc_header"><code>generate_sentences_by_user</code><a href="https://github.com/agacera/udacity_mle_word2vec_recommender/tree/master/word2vec_recommender/model.py#L38" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>generate_sentences_by_user</code>(<strong><code>df</code></strong>:<code>DataFrame</code>)</p>
</blockquote>
<p>Generate the Gensin sentences for a dataframe.
Each sentence is created by joining all ratings from a user sorted by timestamp.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Word2VecMovieRecommender" class="doc_header"><code>class</code> <code>Word2VecMovieRecommender</code><a href="https://github.com/agacera/udacity_mle_word2vec_recommender/tree/master/word2vec_recommender/model.py#L91" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Word2VecMovieRecommender</code>(<strong><code>movies_df</code></strong>:<code>DataFrame</code>, <strong><code>ratings_df</code></strong>:<code>DataFrame</code>, <strong><code>gensim_parameters</code></strong>:<a href="model.html#GensimParameters"><code>GensimParameters</code></a>, <strong><code>positive_rating_threshold</code></strong>:<code>float</code>=<em><code>3.0</code></em>, <strong><code>train_validation_ratio</code></strong>:<code>float</code>=<em><code>0.9</code></em>)</p>
</blockquote>
<p>This class encapsulates the training of recommendations plus utilities for persistance and predictions</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movies_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/ml-latest-small/movies.csv&#39;</span><span class="p">)</span>
<span class="n">movies_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>title</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Toy Story (1995)</td>
      <td>Adventure|Animation|Children|Comedy|Fantasy</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>Jumanji (1995)</td>
      <td>Adventure|Children|Fantasy</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Grumpier Old Men (1995)</td>
      <td>Comedy|Romance</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Waiting to Exhale (1995)</td>
      <td>Comedy|Drama|Romance</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Father of the Bride Part II (1995)</td>
      <td>Comedy</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ratings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/ml-latest-small/ratings.csv&#39;</span><span class="p">)</span>
<span class="n">ratings_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>movieId</th>
      <th>rating</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>4.0</td>
      <td>964982703</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>3</td>
      <td>4.0</td>
      <td>964981247</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>6</td>
      <td>4.0</td>
      <td>964982224</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>47</td>
      <td>5.0</td>
      <td>964983815</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>50</td>
      <td>5.0</td>
      <td>964982931</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">movie_repository</span> <span class="o">=</span> <span class="n">MovieRepository</span><span class="p">(</span>
    <span class="n">movies_df</span><span class="o">=</span><span class="n">movies_df</span>
<span class="p">)</span>

<span class="n">movie_repository</span><span class="o">.</span><span class="n">find_by_movie_id</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Movie(movie_id=1, title=&#39;Toy Story (1995)&#39;, genres=&#39;Adventure|Animation|Children|Comedy|Fantasy&#39;)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">word2vec_recommender</span> <span class="o">=</span> <span class="n">Word2VecMovieRecommender</span><span class="p">(</span>
    <span class="n">movies_df</span><span class="o">=</span><span class="n">movies_df</span><span class="p">,</span>
    <span class="n">ratings_df</span><span class="o">=</span><span class="n">ratings_df</span><span class="p">,</span>
    <span class="n">gensim_parameters</span><span class="o">=</span><span class="n">gensim_parameters</span>
<span class="p">)</span>

<span class="n">word2vec_recommender</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>movies=(9742, 3), ratings=(100836, 4), train_df=(74918, 6), validation_df=(6845, 6)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">word2vec_recommender</span><span class="o">.</span><span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>userId</th>
      <th>rating</th>
      <th>timestamp</th>
      <th>title</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>43</th>
      <td>804</td>
      <td>1</td>
      <td>4.0</td>
      <td>964980499</td>
      <td>She's the One (1996)</td>
      <td>Comedy|Romance</td>
    </tr>
    <tr>
      <th>73</th>
      <td>1210</td>
      <td>1</td>
      <td>5.0</td>
      <td>964980499</td>
      <td>Star Wars: Episode VI - Return of the Jedi (1983)</td>
      <td>Action|Adventure|Sci-Fi</td>
    </tr>
    <tr>
      <th>120</th>
      <td>2018</td>
      <td>1</td>
      <td>5.0</td>
      <td>964980523</td>
      <td>Bambi (1942)</td>
      <td>Animation|Children|Drama</td>
    </tr>
    <tr>
      <th>171</th>
      <td>2628</td>
      <td>1</td>
      <td>4.0</td>
      <td>964980523</td>
      <td>Star Wars: Episode I - The Phantom Menace (1999)</td>
      <td>Action|Adventure|Sci-Fi</td>
    </tr>
    <tr>
      <th>183</th>
      <td>2826</td>
      <td>1</td>
      <td>4.0</td>
      <td>964980523</td>
      <td>13th Warrior, The (1999)</td>
      <td>Action|Adventure|Fantasy</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># sampling of interactions</span>
<span class="n">generate_sentences_by_user</span><span class="p">(</span><span class="n">word2vec_recommender</span><span class="o">.</span><span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[[&#39;804&#39;, &#39;1210&#39;, &#39;2018&#39;, &#39;2628&#39;, &#39;2826&#39;, &#39;3578&#39;, &#39;3617&#39;, &#39;3744&#39;, &#39;101&#39;, &#39;441&#39;]]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">word2vec_recommender</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">print_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Epoch #1 start
Epoch #1 end in 0:00:00.457345 time
Epoch #1, loss 988305.5
Epoch #2 start
Epoch #2 end in 0:00:00.388274 time
Epoch #2, loss 1789852.625
Epoch #3 start
Epoch #3 end in 0:00:00.395134 time
Epoch #3, loss 2509692.5
Epoch #4 start
Epoch #4 end in 0:00:00.398689 time
Epoch #4, loss 3201743.25
Epoch #5 start
Epoch #5 end in 0:00:00.522900 time
Epoch #5, loss 3899677.25
Epoch #6 start
Epoch #6 end in 0:00:00.397705 time
Epoch #6, loss 4555343.5
Epoch #7 start
Epoch #7 end in 0:00:00.389938 time
Epoch #7, loss 5161690.0
Epoch #8 start
Epoch #8 end in 0:00:00.389310 time
Epoch #8, loss 5772640.5
Epoch #9 start
Epoch #9 end in 0:00:00.398168 time
Epoch #9, loss 6375616.0
Epoch #10 start
Epoch #10 end in 0:00:00.387233 time
Epoch #10, loss 6975837.0
Epoch #11 start
Epoch #11 end in 0:00:00.498056 time
Epoch #11, loss 7577800.5
Epoch #12 start
Epoch #12 end in 0:00:00.425463 time
Epoch #12, loss 8173547.5
Epoch #13 start
Epoch #13 end in 0:00:00.423962 time
Epoch #13, loss 8732624.0
Epoch #14 start
Epoch #14 end in 0:00:00.396661 time
Epoch #14, loss 9266077.0
Epoch #15 start
Epoch #15 end in 0:00:00.387911 time
Epoch #15, loss 9797381.0
Epoch #16 start
Epoch #16 end in 0:00:00.412464 time
Epoch #16, loss 10330830.0
Epoch #17 start
Epoch #17 end in 0:00:00.397766 time
Epoch #17, loss 10857930.0
Epoch #18 start
Epoch #18 end in 0:00:00.394495 time
Epoch #18, loss 11385034.0
Epoch #19 start
Epoch #19 end in 0:00:00.408265 time
Epoch #19, loss 11908243.0
Epoch #20 start
Epoch #20 end in 0:00:00.420740 time
Epoch #20, loss 12433047.0
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Generating Recommendations</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">seed_id</span> <span class="o">=</span> <span class="mi">1210</span>
<span class="n">recommendations</span> <span class="o">=</span> <span class="n">word2vec_recommender</span><span class="o">.</span><span class="n">similar_by_movie_id</span><span class="p">(</span><span class="n">seed_id</span><span class="p">)</span>
<span class="n">print_recommendations</span><span class="p">(</span><span class="n">movie_repository</span><span class="p">,</span> <span class="n">seed_id</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Movie(movie_id=1210, title=&#39;Star Wars: Episode VI - Return of the Jedi (1983)&#39;, genres=&#39;Action|Adventure|Sci-Fi&#39;)
&gt; Recommendations:
&gt;&gt; Movie(movie_id=260, title=&#39;Star Wars: Episode IV - A New Hope (1977)&#39;, genres=&#39;Action|Adventure|Sci-Fi&#39;) score=0.5200915336608887
&gt;&gt; Movie(movie_id=1196, title=&#39;Star Wars: Episode V - The Empire Strikes Back (1980)&#39;, genres=&#39;Action|Adventure|Sci-Fi&#39;) score=0.5094590783119202
&gt;&gt; Movie(movie_id=800, title=&#39;Lone Star (1996)&#39;, genres=&#39;Drama|Mystery|Western&#39;) score=0.4613412320613861
&gt;&gt; Movie(movie_id=1356, title=&#39;Star Trek: First Contact (1996)&#39;, genres=&#39;Action|Adventure|Sci-Fi|Thriller&#39;) score=0.4387352466583252
&gt;&gt; Movie(movie_id=66, title=&#39;Lawnmower Man 2: Beyond Cyberspace (1996)&#39;, genres=&#39;Action|Sci-Fi|Thriller&#39;) score=0.4334386885166168
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">seed_id</span> <span class="o">=</span> <span class="mi">110</span>
<span class="n">recommendations</span> <span class="o">=</span> <span class="n">word2vec_recommender</span><span class="o">.</span><span class="n">similar_by_movie_id</span><span class="p">(</span><span class="n">seed_id</span><span class="p">)</span>
<span class="n">print_recommendations</span><span class="p">(</span><span class="n">movie_repository</span><span class="p">,</span> <span class="n">seed_id</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Movie(movie_id=110, title=&#39;Braveheart (1995)&#39;, genres=&#39;Action|Drama|War&#39;)
&gt; Recommendations:
&gt;&gt; Movie(movie_id=356, title=&#39;Forrest Gump (1994)&#39;, genres=&#39;Comedy|Drama|Romance|War&#39;) score=0.5963975191116333
&gt;&gt; Movie(movie_id=457, title=&#39;Fugitive, The (1993)&#39;, genres=&#39;Thriller&#39;) score=0.5477665662765503
&gt;&gt; Movie(movie_id=2028, title=&#39;Saving Private Ryan (1998)&#39;, genres=&#39;Action|Drama|War&#39;) score=0.5424777269363403
&gt;&gt; Movie(movie_id=593, title=&#39;Silence of the Lambs, The (1991)&#39;, genres=&#39;Crime|Horror|Thriller&#39;) score=0.5397478938102722
&gt;&gt; Movie(movie_id=47, title=&#39;Seven (a.k.a. Se7en) (1995)&#39;, genres=&#39;Mystery|Thriller&#39;) score=0.5353078842163086
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Saving embeddings</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">word2vec_recommender</span><span class="o">.</span><span class="n">save_all</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;./data/out&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls -lh ./data/out/
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>total 16808
-rw-r--r--  1 felipe.gasparini  2119619082   1.1M Dec 19 21:56 embeddings.pkl
-rw-r--r--  1 felipe.gasparini  2119619082   5.2M Dec 19 21:56 model.gensim
-rw-r--r--  1 felipe.gasparini  2119619082    68K Dec 19 21:56 words_index.pkl
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Plotting embeddings</p>

</div>
</div>
</div>
</div>
 

